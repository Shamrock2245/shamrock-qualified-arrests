<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Shamrock Bail Bonds - Application Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #f5f5f5;
      padding: 20px;
      min-height: 100vh;
    }

    .form-container {
      max-width: 900px;
      margin: 0 auto;
      background: #2a2a2a;
      border: 2px solid #FFD700;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
      overflow: hidden;
    }

    .form-header {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      padding: 30px;
      text-align: center;
      border-bottom: 3px solid #FFD700;
    }

    .form-header h1 {
      color: #FFD700;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      margin-bottom: 10px;
      font-family: 'Times New Roman', serif;
    }

    .form-header p {
      color: #cccccc;
      font-size: 1.1em;
      font-style: italic;
    }

    .tabs {
      display: flex;
      background: #1a1a1a;
      border-bottom: 2px solid #FFD700;
    }

    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background: #2a2a2a;
      color: #cccccc;
      border-right: 1px solid #444;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .tab:last-child {
      border-right: none;
    }

    .tab:hover {
      background: #333;
      color: #FFD700;
    }

    .tab.active {
      background: #FFD700;
      color: #000;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .tab-content {
      display: none;
      padding: 30px;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h3 {
      color: #FFD700;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #444;
      font-size: 1.4em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #FFD700;
      font-weight: bold;
      font-size: 0.95em;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      background: #1a1a1a;
      border: 2px solid #444;
      border-radius: 4px;
      color: #f5f5f5;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 20px;
    }

    button {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      padding: 15px 40px;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    .button-container {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #444;
    }

    .nav-button {
      background: linear-gradient(135deg, #444 0%, #666 100%);
      color: #FFD700;
    }

    .submit-button {
      background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
      color: white;
    }

    .required {
      color: #ff6b6b;
      margin-left: 4px;
    }

    .auto-populated {
      background: #2d3d2d !important;
      border-color: #32CD32 !important;
    }

    .info-box {
      background: #1a1a1a;
      border-left: 4px solid #FFD700;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .info-box p {
      color: #cccccc;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .form-row,
      .form-row-3 {
        grid-template-columns: 1fr;
      }

      .form-header h1 {
        font-size: 1.8em;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        border-right: none;
        border-bottom: 1px solid #444;
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div class="form-header">
      <h1>üçÄ Shamrock Bail Bonds</h1>
      <p>Professional Bond Application Form</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab(0)">Defendant Information</div>
      <div class="tab" onclick="showTab(1)">Contact & Address</div>
      <div class="tab" onclick="showTab(2)">Case Details</div>
      <div class="tab" onclick="showTab(3)">Indemnitor Information</div>
      <div class="tab" onclick="showTab(4)">Review & Submit</div>
    </div>

    <form id="bondApplicationForm">
      <!-- Tab 1: Defendant Information -->
      <div class="tab-content active" id="tab0">
        <div class="form-section">
          <h3>Defendant Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="defendantFullName">Full Legal Name <span class="required">*</span></label>
              <input type="text" id="defendantFullName" name="defendantFullName" required>
            </div>
            <div class="form-group">
              <label for="defendantDOB">Date of Birth <span class="required">*</span></label>
              <input type="date" id="defendantDOB" name="defendantDOB" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="defendantPhone">Phone Number <span class="required">*</span></label>
              <input type="tel" id="defendantPhone" name="defendantPhone" required>
            </div>
            <div class="form-group">
              <label for="defendantEmail">Email Address</label>
              <input type="email" id="defendantEmail" name="defendantEmail">
            </div>
          </div>

          <div class="form-group">
            <label for="bookingNumber">Booking Number</label>
            <input type="text" id="bookingNumber" name="bookingNumber">
          </div>
        </div>

        <div class="button-container">
          <button type="button" disabled>Previous</button>
          <button type="button" class="nav-button" onclick="showTab(1)">Next</button>
        </div>
      </div>

      <!-- Tab 2: Contact & Address -->
      <div class="tab-content" id="tab1">
        <div class="form-section">
          <h3>Contact & Address Information</h3>
          
          <div class="form-group">
            <label for="defendantAddress">Street Address <span class="required">*</span></label>
            <input type="text" id="defendantAddress" name="defendantAddress" required>
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label for="defendantCity">City <span class="required">*</span></label>
              <input type="text" id="defendantCity" name="defendantCity" required>
            </div>
            <div class="form-group">
              <label for="defendantState">State <span class="required">*</span></label>
              <input type="text" id="defendantState" name="defendantState" required>
            </div>
            <div class="form-group">
              <label for="defendantZip">ZIP Code <span class="required">*</span></label>
              <input type="text" id="defendantZip" name="defendantZip" required>
            </div>
          </div>
        </div>

        <div class="button-container">
          <button type="button" class="nav-button" onclick="showTab(0)">Previous</button>
          <button type="button" class="nav-button" onclick="showTab(2)">Next</button>
        </div>
      </div>

      <!-- Tab 3: Case Details -->
      <div class="tab-content" id="tab2">
        <div class="form-section">
          <h3>Case Information</h3>

          <div class="info-box">
            <p><strong>Note:</strong> These fields will auto-populate if you opened this form from the arrest database.</p>
          </div>

          <div class="form-group">
            <label for="charges">Charges <span class="required">*</span></label>
            <textarea id="charges" name="charges" required></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bondAmount">Bond Amount <span class="required">*</span></label>
              <input type="text" id="bondAmount" name="bondAmount" required>
            </div>
            <div class="form-group">
              <label for="bondType">Bond Type</label>
              <input type="text" id="bondType" name="bondType">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="caseNumber">Case Number(s)</label>
              <input type="text" id="caseNumber" name="caseNumber">
            </div>
            <div class="form-group">
              <label for="county">County</label>
              <input type="text" id="county" name="county">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="courtDate">Court Date</label>
              <input type="date" id="courtDate" name="courtDate">
            </div>
            <div class="form-group">
              <label for="courtTime">Court Time</label>
              <input type="text" id="courtTime" name="courtTime">
            </div>
          </div>

          <div class="form-group">
            <label for="courtLocation">Court Location</label>
            <input type="text" id="courtLocation" name="courtLocation">
          </div>
        </div>

        <div class="button-container">
          <button type="button" class="nav-button" onclick="showTab(1)">Previous</button>
          <button type="button" class="nav-button" onclick="showTab(3)">Next</button>
        </div>
      </div>

      <!-- Tab 4: Indemnitor Information -->
      <div class="tab-content" id="tab3">
        <div class="form-section">
          <h3>Indemnitor Information</h3>

          <div class="info-box">
            <p><strong>Indemnitor:</strong> The person financially responsible for the bond (often a family member or friend).</p>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="indemnitorName">Full Name <span class="required">*</span></label>
              <input type="text" id="indemnitorName" name="indemnitorName" required>
            </div>
            <div class="form-group">
              <label for="indemnitorRelationship">Relationship to Defendant <span class="required">*</span></label>
              <input type="text" id="indemnitorRelationship" name="indemnitorRelationship" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="indemnitorPhone">Phone Number <span class="required">*</span></label>
              <input type="tel" id="indemnitorPhone" name="indemnitorPhone" required>
            </div>
            <div class="form-group">
              <label for="indemnitorEmail">Email Address <span class="required">*</span></label>
              <input type="email" id="indemnitorEmail" name="indemnitorEmail" required>
            </div>
          </div>

          <div class="form-group">
            <label for="indemnitorAddress">Street Address <span class="required">*</span></label>
            <input type="text" id="indemnitorAddress" name="indemnitorAddress" required>
          </div>

          <div class="form-row-3">
            <div class="form-group">
              <label for="indemnitorCity">City <span class="required">*</span></label>
              <input type="text" id="indemnitorCity" name="indemnitorCity" required>
            </div>
            <div class="form-group">
              <label for="indemnitorState">State <span class="required">*</span></label>
              <input type="text" id="indemnitorState" name="indemnitorState" required>
            </div>
            <div class="form-group">
              <label for="indemnitorZip">ZIP Code <span class="required">*</span></label>
              <input type="text" id="indemnitorZip" name="indemnitorZip" required>
            </div>
          </div>

          <div class="form-group">
            <label for="indemnitorEmployer">Employer</label>
            <input type="text" id="indemnitorEmployer" name="indemnitorEmployer">
          </div>
        </div>

        <div class="button-container">
          <button type="button" class="nav-button" onclick="showTab(2)">Previous</button>
          <button type="button" class="nav-button" onclick="showTab(4)">Next</button>
        </div>
      </div>

      <!-- Tab 5: Review & Submit -->
      <div class="tab-content" id="tab4">
        <div class="form-section">
          <h3>Review & Submit</h3>

          <div class="info-box">
            <p><strong>Please review all information before submitting.</strong> Once submitted, our team will review your application and contact you within 24 hours.</p>
          </div>

          <div class="form-group">
            <label for="additionalNotes">Additional Notes or Questions</label>
            <textarea id="additionalNotes" name="additionalNotes" placeholder="Include any additional information that may be helpful..."></textarea>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
              I understand that I am financially responsible for ensuring the defendant appears at all court dates, and I agree to the terms and conditions of Shamrock Bail Bonds. <span class="required">*</span>
            </label>
          </div>
        </div>

        <div class="button-container">
          <button type="button" class="nav-button" onclick="showTab(3)">Previous</button>
          <button type="submit" class="submit-button">Submit Application</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    console.log('üîß Form.html script initializing...');
    
    // Initialize ALL_MAPS if it doesn't exist (prevents null reference errors)
    window.ALL_MAPS = window.ALL_MAPS || {};
    console.log('‚úÖ window.ALL_MAPS initialized');

    // Check if FORM_DATA was injected
    if (window.FORM_DATA) {
      console.log('‚úÖ window.FORM_DATA =', window.FORM_DATA);
      
      // Fetch arrest data from server
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('‚úÖ Data received from server:', data);
          console.log('üìã Data keys:', Object.keys(data));
          populateFormFromArrest(data);
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Error fetching data:', error);
          alert('Error loading arrest data: ' + error.message);
        })
        .getArrestDataForForm(window.FORM_DATA.booking, window.FORM_DATA.row);
    } else {
      console.log('‚ÑπÔ∏è No FORM_DATA - form opened manually');
    }

    function showTab(tabIndex) {
      console.log('üìë Switching to tab:', tabIndex);
      
      // Hide all tabs
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Show selected tab
      tabs[tabIndex].classList.add('active');
      tabContents[tabIndex].classList.add('active');
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    function populateFormFromArrest(data) {
      console.log('üéØ populateFormFromArrest called');
      console.log('üì¶ Received data object:', data);
      console.log('üìã Data keys:', Object.keys(data));
      
      if (!data || typeof data !== 'object') {
        console.error('‚ùå Invalid data object received');
        return;
      }

      // Field mapping: formFieldId -> spreadsheet column name(s)
      const fieldMappings = {
        // Defendant info
        'defendantFullName': ['Full_Name', 'Full Name'],
        'defendantDOB': ['DOB'],
        'bookingNumber': ['Booking_Number', 'Booking Number'],
        
        // Contact & Address
        'defendantAddress': ['Address'],
        'defendantCity': ['City'],
        'defendantState': ['State'],
        'defendantZip': ['ZIP', 'Zip'],
        
        // Case Details
        'charges': ['All_Charges', 'All Charges'],
        'bondAmount': ['Bond_Amount', 'Bond Amount'],
        'bondType': ['Bond_Type', 'Bond Type'],
        'caseNumber': ['Case_Numbers', 'Case Numbers'],
        'county': ['County'],
        'courtDate': ['Court_Date', 'Court Date'],
        'courtTime': ['Court_Time', 'Court Time'],
        'courtLocation': ['Court_Location', 'Court Location']
      };

      let populatedCount = 0;
      let skippedCount = 0;

      // Iterate through each field mapping
      for (const [fieldId, possibleKeys] of Object.entries(fieldMappings)) {
        const element = document.getElementById(fieldId);
        
        if (!element) {
          console.warn(`‚ö†Ô∏è Element not found: ${fieldId}`);
          continue;
        }

        // Try each possible key for this field
        let value = null;
        let usedKey = null;

        for (const key of possibleKeys) {
          if (data[key] !== undefined && data[key] !== null && data[key] !== '') {
            value = data[key];
            usedKey = key;
            break;
          }
        }

        if (value !== null) {
          // Format the value based on field type
          if (fieldId === 'defendantDOB' || fieldId === 'courtDate') {
            // Convert date to YYYY-MM-DD format for date inputs
            try {
              const date = new Date(value);
              if (!isNaN(date.getTime())) {
                value = date.toISOString().split('T')[0];
              }
            } catch (e) {
              console.warn(`‚ö†Ô∏è Date parsing error for ${fieldId}:`, e);
            }
          } else if (fieldId === 'bondAmount') {
            // Clean and format bond amount
            value = String(value).replace(/[^0-9.]/g, '');
            if (value) {
              value = '$' + parseFloat(value).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });
            }
          }

          element.value = value;
          element.classList.add('auto-populated');
          console.log(`‚úÖ Populated ${fieldId} from "${usedKey}": ${value}`);
          populatedCount++;
        } else {
          console.log(`‚è≠Ô∏è Skipped ${fieldId} (no data in: ${possibleKeys.join(', ')})`);
          skippedCount++;
        }
      }

      console.log(`üìä Population summary: ${populatedCount} populated, ${skippedCount} skipped`);
      
      if (populatedCount === 0) {
        console.error('‚ùå NO FIELDS POPULATED - Check data keys vs. fieldMappings');
        console.log('üîç Available data keys:', Object.keys(data));
        console.log('üîç Expected keys in fieldMappings:', Object.values(fieldMappings).flat());
      }
    }

    // Form submission handler
    document.getElementById('bondApplicationForm').addEventListener('submit', function(e) {
      e.preventDefault();
      console.log('üì§ Form submission triggered');
      
      const formData = new FormData(e.target);
      const formObject = {};
      
      formData.forEach((value, key) => {
        formObject[key] = value;
      });
      
      console.log('üìã Form data:', formObject);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('‚úÖ Form submitted successfully:', result);
          alert('Application submitted successfully! We will contact you within 24 hours.');
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          console.error('‚ùå Form submission error:', error);
          alert('Error submitting form: ' + error.message);
        })
        .submitBondApplication(formObject);
    });

    console.log('‚úÖ Form.html script initialization complete');
  </script>
</body>
</html>