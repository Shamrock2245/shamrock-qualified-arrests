<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shamrock Bail Bonds ‚Äî Bond Application</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* ========= THEME ========= */
        :root {
            --tux-black: #0B0B0C;
            --tux-charcoal: #151517;
            --tux-ink: #1B1C1F;
            --tux-white: #FFFFFF;
            --shamrock: #00A86B;
            --shamrock-2: #19C58A;
            --text: #EDEEF0;
            --muted: #A8ACB4;
            --line: #24262B;
            --accent: #00c27b;
            --warning: #F5C044;
            --danger: #EF4444;
            --bg-form: #0f1013;
            --chip: #0b1a14;
        }

        /* ========= BASE ========= */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html,
        body {
            height: 100%
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background:
                radial-gradient(1200px 600px at 10% -10%, rgba(0, 168, 107, .12) 0%, transparent 70%),
                radial-gradient(900px 500px at 120% 10%, rgba(0, 168, 107, .14) 0%, transparent 60%),
                linear-gradient(180deg, #0a0b0d 0%, #0e1013 100%);
            color: var(--text);
            padding: 18px;
        }

        /* ========= CONTAINER ========= */
        .container {
            max-width: 1160px;
            margin: 0 auto;
            background: var(--tux-ink);
            border: 1px solid var(--line);
            border-radius: 22px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .35)
        }

        /* ========= TUXEDO HEADER ========= */
        .header {
            position: relative;
            background: var(--tux-black);
            padding: 64px 28px 84px;
            border-bottom: 1px solid var(--line);
        }

        .header-inner {
            max-width: 1160px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 24px;
            align-items: center
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 2
        }

        .brand img {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            object-fit: contain;
            background: #fff;
            padding: 6px;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .45)
        }

        .brand .title {
            font-weight: 800;
            letter-spacing: .2px;
            font-size: 1.6rem;
            line-height: 1.1
        }

        .brand .subtitle {
            font-size: .95rem;
            color: var(--muted)
        }

        /* Bow tie */
        .header .bow {
            position: absolute;
            left: 50%;
            top: 22px;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            pointer-events: none;
        }

        .bow:before,
        .bow:after {
            content: "";
            position: absolute;
            top: 38px;
            width: 56px;
            height: 56px;
            background: var(--tux-black);
            border: 1px solid #1f2228;
            border-radius: 8px;
            transform: skewX(-12deg) rotate(45deg);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .03), 0 10px 24px rgba(0, 0, 0, .35)
        }

        .bow:before {
            left: 0;
            background: linear-gradient(135deg, #121316 0%, #0c0d10 100%)
        }

        .bow:after {
            right: 0;
            background: linear-gradient(225deg, #121316 0%, #0c0d10 100%)
        }

        .knot {
            position: absolute;
            left: 50%;
            top: 64px;
            transform: translateX(-50%);
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: linear-gradient(180deg, #0f1216, #0b0d11);
            border: 1px solid #1f2228;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .45)
        }

        /* Lapels */
        .header:before,
        .header:after {
            content: "";
            position: absolute;
            top: -120px;
            width: 52vw;
            height: 300px;
            background: linear-gradient(180deg, #0e1013 0%, #0b0c0f 90%);
            border-bottom: 1px solid #1a1d22;
            z-index: 0;
            filter: drop-shadow(0 14px 40px rgba(0, 0, 0, .45))
        }

        .header:before {
            left: -6vw;
            transform: skewY(-8deg) rotate(-2deg)
        }

        .header:after {
            right: -6vw;
            transform: skewY(8deg) rotate(2deg)
        }

        /* Address/phone chip */
        .contact {
            justify-self: end;
            text-align: right;
            z-index: 2
        }

        .contact .chip {
            display: inline-flex;
            gap: 12px;
            align-items: center;
            background: linear-gradient(180deg, #0d1a14, #09140f);
            border: 1px solid #163a2c;
            color: #b7f5d6;
            padding: 10px 14px;
            border-radius: 999px;
            font-weight: 600;
            font-size: .92rem
        }

        .contact small {
            display: block;
            color: var(--muted);
            margin-top: 8px
        }

        /* Green underline stripe */
        .header-underline {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 6px;
            background: linear-gradient(90deg, transparent, var(--shamrock), var(--shamrock-2), transparent)
        }

        /* Auto-fill badge */
        .auto-fill-badge {
            margin-top: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(0, 168, 107, .1);
            border: 1px solid rgba(0, 168, 107, .35);
            color: #b7f5d6;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: .9rem;
            font-weight: 600
        }

        .auto-fill-badge:before {
            content: "‚úì";
            display: inline-grid;
            place-items: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #18c583;
            color: #05140f;
            font-weight: 800
        }

        /* ========= NAV TABS ========= */
        .tabs {
            display: flex;
            background: var(--tux-ink);
            border-bottom: 1px solid var(--line)
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 16px 10px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: .2px;
            cursor: pointer;
            transition: all .2s ease;
            position: relative
        }

        .tab:hover {
            color: #cfeee0;
            background: rgba(0, 168, 107, .06)
        }

        .tab.active {
            color: #eafff6
        }

        .tab.active:after {
            content: "";
            position: absolute;
            left: 8%;
            right: 8%;
            bottom: -1px;
            height: 3px;
            border-radius: 3px;
            background: linear-gradient(90deg, transparent, var(--shamrock), transparent)
        }

        /* ========= CONTENT ========= */
        .tab-content {
            display: none;
            padding: 30px
        }

        .tab-content.active {
            display: block
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 18px;
            color: #eef7f1;
            letter-spacing: .2px;
            border-left: 4px solid var(--shamrock);
            padding-left: 12px
        }

        .info-card {
            background: linear-gradient(180deg, #0f1317, #0d1114);
            border: 1px solid #1a1e24;
            border-radius: 14px;
            padding: 16px;
            margin: 12px 0 22px
        }

        .info-card-title {
            color: #86ffd0;
            font-weight: 700;
            margin-bottom: 8px
        }

        /* Grid rows */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 16px
        }

        .form-group label {
            display: block;
            margin: 0 0 8px;
            color: #dfe6ea;
            font-weight: 700;
            font-size: .9rem
        }

        label.required:after {
            content: " *";
            color: var(--warning)
        }

        input,
        select,
        textarea {
            width: 100%;
            background: var(--bg-form);
            color: var(--text);
            border: 1px solid #252a31;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: .98rem;
            transition: border .2s ease, box-shadow .2s ease
        }

        input::placeholder {
            color: #6f7683
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2b7d5e;
            box-shadow: 0 0 0 3px rgba(0, 168, 107, .12)
        }

        input[readonly] {
            opacity: .9
        }

        input.auto-filled {
            border-color: #1e7f5d;
            background: linear-gradient(180deg, #0e1512, #0b1310)
        }

        /* Charges */
        .charge-item {
            background: linear-gradient(180deg, #0f1216, #0c1013);
            border: 1px solid #1a1e24;
            border-left: 4px solid var(--shamrock);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px
        }

        .charge-item h4 {
            color: #9ff2d2;
            margin-bottom: 10px;
            font-size: 1rem
        }

        .premium-summary {
            background: linear-gradient(180deg, #1a1203, #100c06);
            border: 1px solid #3b2a06;
            border-left: 4px solid #b88b15;
            border-radius: 14px;
            padding: 18px;
            margin: 10px 0 18px
        }

        .premium-total {
            font-size: 1.6rem;
            color: #ffe98a
        }

        /* Buttons */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 12px 18px;
            font-weight: 800;
            cursor: pointer;
            display: inline-flex;
            gap: 8px;
            align-items: center
        }

        .btn-primary {
            background: linear-gradient(180deg, #10bd7e, #0aa86f);
            color: #02140E
        }

        .btn-primary:hover {
            filter: brightness(1.05)
        }

        .btn-secondary {
            background: #0e1216;
            color: #dfe6ea;
            border: 1px solid #232830
        }

        .btn-success {
            background: #13b981;
            color: #03130E
        }

        .btn-danger {
            background: #ef4444;
            color: #fff
        }

        .btn:active {
            transform: translateY(1px)
        }

        /* Progress */
        .progress-bar {
            height: 6px;
            background: #0d0f12
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--shamrock), var(--shamrock-2));
        }

        /* Footer bar */
        .footer {
            border-top: 1px solid var(--line);
            background: var(--tux-ink);
            padding: 14px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .footer .brand-mini {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .footer .brand-mini img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #fff;
            padding: 3px
        }

        .footer small {
            color: var(--muted)
        }

        @media (max-width:760px) {
            .header-inner {
                grid-template-columns: 1fr;
                gap: 12px;
                text-align: center
            }

            .contact {
                justify-self: center
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Tuxedo header -->
        <div class="header">
            <div class="bow"></div>
            <div class="knot"></div>
            <div class="header-inner">
                <div class="brand">
                    <img src="LOGO_URL_HERE" alt="Shamrock Bail Bonds Logo">
                    <div>
                        <div class="title">Shamrock Bail Bonds</div>
                        <div class="subtitle">Bond Application ‚Äî Secure & Streamlined</div>
                        <div id="autoFillBadge" class="auto-fill-badge">Data auto-populated from arrest record</div>
                    </div>
                </div>
                <span></span>
                <div class="contact">
                    <div class="chip">üìû 239-332-BAIL</div>
                    <small>1528 Broadway, Ft. Myers, FL 33901</small>
                </div>
            </div>
            <div class="header-underline"></div>
        </div>

        <!-- Progress -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:33%"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üë§ Defendant Info</button>
            <button class="tab" onclick="switchTab(1)">‚öñÔ∏è Charges & Bond</button>
            <button class="tab" onclick="switchTab(2)">ü§ù Indemnitor Info</button>
            <button class="tab" onclick="switchTab(3)">üìã Review & Submit</button>
        </div>

        <!-- ===== TAB 1 ===== -->
        <div class="tab-content active">
            <h3 class="section-title">Defendant Information</h3>
            <div class="info-card">
                <div class="info-card-title">üìå Auto-Populated Fields</div>
                <p>Fields with a subtle green border were filled from the arrest record. Please review.</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="required">Full Legal Name</label>
                    <input type="text" id="defendantFullName" placeholder="Last, First Middle" required>
                </div>
                <div class="form-group">
                    <label class="required">Date of Birth</label>
                    <input type="date" id="defendantDOB" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Social Security Number</label>
                    <input type="text" id="defendantSSN" placeholder="XXX-XX-XXXX">
                </div>
                <div class="form-group">
                    <label>Driver's License Number</label>
                    <input type="text" id="defendantDL" placeholder="License number">
                </div>
            </div>

            <h3 class="section-title" style="border-left-color:#2b7d5e">Address</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="required">Street Address</label>
                    <input type="text" id="defendantStreetAddress" placeholder="123 Main St" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="required">City</label>
                    <input type="text" id="defendantCity" placeholder="Fort Myers" required>
                </div>
                <div class="form-group">
                    <label class="required">State</label>
                    <select id="defendantDLState" required>
                        <option value="FL">Florida</option>
                        <option value="AL">Alabama</option>
                        <option value="GA">Georgia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="required">ZIP Code</label>
                    <input type="text" id="defendantZip" placeholder="33901" required>
                </div>
            </div>

            <h3 class="section-title" style="border-left-color:#2b7d5e">Physical Description</h3>
            <div class="form-row">
                <div class="form-group"><label>Race</label><input type="text" id="defendantRace"></div>
                <div class="form-group">
                    <label>Sex</label>
                    <select id="defendantSex">
                        <option value="">Select</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                    </select>
                </div>
                <div class="form-group"><label>Height</label><input type="text" id="defendantHeight"
                        placeholder="5'10&quot;"></div>
                <div class="form-group"><label>Weight</label><input type="text" id="defendantWeight"
                        placeholder="180 lbs"></div>
            </div>

            <div style="text-align:right;margin-top:18px">
                <button class="btn btn-primary" onclick="switchTab(1)">Next: Charges & Bond ‚Üí</button>
            </div>
        </div>

        <!-- ===== TAB 2 ===== -->
        <div class="tab-content">
            <h3 class="section-title">Charges & Bond Information</h3>

            <div class="premium-summary">
                <h4 style="margin-bottom:8px">üí∞ Premium Calculation (Florida Law)</h4>
                <p style="color:#e9e2c6;margin-bottom:8px">Each charge: greater of <b>$100</b> or <b>10%</b> of bond
                    amount</p>
                <div id="premiumBreakdown" style="font-size:.95em;margin:10px 0">Add charges to see premium breakdown
                </div>
                <div
                    style="display:flex;gap:18px;justify-content:space-between;align-items:center;margin-top:8px;padding-top:12px;border-top:1px dashed rgba(255,224,143,.35)">
                    <div>
                        <div style="font-size:.9em;color:#e9e2c6">Total Bond Amount</div>
                        <div style="font-size:1.35em;font-weight:800" id="totalBond">$0.00</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:.9em;color:#e9e2c6">Total Premium Due</div>
                        <div class="premium-total" id="totalPremium">$0.00</div>
                    </div>
                </div>
            </div>

            <div id="chargesContainer"></div>
            <button class="btn btn-success" onclick="addCharge()">+ Add Charge</button>

            <div style="display:flex;justify-content:space-between;margin-top:22px">
                <button class="btn btn-secondary" onclick="switchTab(0)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="switchTab(2)">Next: Indemnitor Info ‚Üí</button>
            </div>
        </div>

        <!-- ===== TAB 3 ===== -->
        <div class="tab-content">
            <h3 class="section-title">Indemnitor Information</h3>
            <div class="info-card">
                <div class="info-card-title">‚ÑπÔ∏è About the Indemnitor</div>
                <p>The indemnitor is the person who agrees to be financially responsible for the defendant.</p>
            </div>

            <div class="form-row">
                <div class="form-group"><label class="required">Full Name</label><input type="text"
                        id="indemnitorFullName" required placeholder="First Last"></div>
                <div class="form-group"><label class="required">Relationship to Defendant</label><input type="text"
                        id="indemnitorRelationship" required placeholder="Mother, Spouse, Friend, etc."></div>
            </div>

            <div class="form-row">
                <div class="form-group"><label class="required">Phone Number</label><input type="tel"
                        id="indemnitorPhone" required placeholder="(239) 555-1234"></div>
                <div class="form-group"><label class="required">Email Address</label><input type="email"
                        id="indemnitorEmail" required placeholder="email@example.com"></div>
            </div>

            <div class="form-row">
                <div class="form-group"><label class="required">Date of Birth</label><input type="date"
                        id="indemnitorDOB" required></div>
                <div class="form-group"><label>Social Security Number</label><input type="text" id="indemnitorSSN"
                        placeholder="XXX-XX-XXXX"></div>
            </div>

            <h3 class="section-title" style="border-left-color:#2b7d5e">Indemnitor Address</h3>
            <div class="form-row">
                <div class="form-group"><label class="required">Street Address</label><input type="text"
                        id="indemnitorStreetAddress" required placeholder="123 Main St"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label class="required">City</label><input type="text" id="indemnitorCity"
                        required placeholder="Fort Myers"></div>
                <div class="form-group">
                    <label class="required">State</label>
                    <select id="indemnitorState" required>
                        <option value="FL">Florida</option>
                        <option value="AL">Alabama</option>
                        <option value="GA">Georgia</option>
                    </select>
                </div>
                <div class="form-group"><label class="required">ZIP Code</label><input type="text" id="indemnitorZip"
                        required placeholder="33901"></div>
            </div>

            <div style="display:flex;justify-content:space-between;margin-top:22px">
                <button class="btn btn-secondary" onclick="switchTab(1)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="switchTab(3)">Next: Review & Submit ‚Üí</button>
            </div>
        </div>

        <!-- ===== TAB 4 ===== -->
        <div class="tab-content">
            <h3 class="section-title">Review & Submit</h3>
            <div class="info-card" style="border-color:#1f493a;background:linear-gradient(180deg,#0d1412,#0a120f)">
                <div class="info-card-title" style="color:#90ffd7">‚úì Ready to Submit</div>
                <p>Review your entries. On submission, this application is sent for e-signature.</p>
            </div>

            <div class="info-card">
                <h4 style="margin-bottom:10px">Summary</h4>
                <div style="display:grid;gap:10px">
                    <div
                        style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #2a2f37">
                        <span style="color:#b3bac5">Defendant:</span><span id="reviewDefendantName"
                            style="font-weight:800">-</span></div>
                    <div
                        style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #2a2f37">
                        <span style="color:#b3bac5">Number of Charges:</span><span id="reviewChargeCount"
                            style="font-weight:800">0</span></div>
                    <div
                        style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #2a2f37">
                        <span style="color:#b3bac5">Total Bond Amount:</span><span id="reviewTotalBond"
                            style="font-weight:800">$0.00</span></div>
                    <div style="display:flex;justify-content:space-between;padding:10px 0"><span
                            style="color:#b3bac5">Total Premium Due:</span><span id="reviewTotalPremium"
                            style="font-weight:900;font-size:1.2rem;color:#9ff2d2">$0.00</span></div>
                </div>
            </div>

            <div style="display:flex;justify-content:space-between;margin-top:14px">
                <button class="btn btn-secondary" onclick="switchTab(2)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="submitForm()"
                    style="padding:14px 28px;font-size:1.05rem">Submit Application ‚Üí</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="brand-mini">
                <img src="LOGO_URL_HERE" alt="Shamrock logo">
                <small>Shamrock Bail Bonds ‚Ä¢ 1528 Broadway, Ft. Myers, FL 33901</small>
            </div>
            <small>üìû 239-332-BAIL</small>
        </div>
    </div>

    <script>
        // ========== CRITICAL FIX: Initialize ALL_MAPS to prevent errors ==========
        window.ALL_MAPS = window.ALL_MAPS || {};
        
        // ========== GLOBAL STATE ==========
        let charges = [];
        let chargeCounter = 0;

        console.log('üöÄ Form script initializing...');
        console.log('üì¶ window.FORM_DATA at script load:', window.FORM_DATA);

        // ========== INITIALIZATION ==========
        window.onload = function() {
            console.log('‚úÖ window.onload fired');
            console.log('üì¶ window.FORM_DATA in onload:', window.FORM_DATA);
            
            const bookingNumber = window.FORM_DATA ? window.FORM_DATA.booking : null;
            const rowIndex = window.FORM_DATA ? window.FORM_DATA.row : null;
            
            if (bookingNumber && rowIndex) {
                console.log('üìû Calling loadArrestData with booking:', bookingNumber, 'row:', rowIndex);
                document.getElementById('autoFillBadge').style.display = 'inline-flex';
                loadArrestData(bookingNumber, parseInt(rowIndex));
            } else {
                console.warn('‚ö†Ô∏è No FORM_DATA found, adding empty charge');
                addCharge();
            }
        };

        // ========== TAB SWITCHING ==========
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((t, i) => {
                if (i === index) {
                    t.classList.add('active');
                    contents[i].classList.add('active');
                } else {
                    t.classList.remove('active');
                    contents[i].classList.remove('active');
                }
            });
            
            const progress = ((index + 1) / 4 * 100) + '%';
            document.getElementById('progressFill').style.width = progress;
            
            if (index === 3) {
                updateReviewTab();
            }
        }

        // ========== CHARGE MANAGEMENT ==========
        function addCharge() {
            chargeCounter++;
            const id = chargeCounter;
            
            const html = `
                <div class="charge-item" id="charge-${id}">
                    <h4>Charge #${id}</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Offense/Charge Description</label>
                            <input type="text" id="charge${id}Description" oninput="updatePremiums()" required>
                        </div>
                        <div class="form-group">
                            <label class="required">Case Number</label>
                            <input type="text" id="charge${id}CaseNumber" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Bond Amount ($)</label>
                            <input type="number" id="charge${id}BondAmount" step="0.01" oninput="updatePremiums()" required>
                        </div>
                        <div class="form-group">
                            <label>Premium ($) - Auto-Calculated</label>
                            <input type="number" id="charge${id}Premium" step="0.01" readonly style="background:#0b0e12">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Court Location</label>
                            <input type="text" id="charge${id}CourtLocation" placeholder="Circuit Court">
                        </div>
                        <div class="form-group">
                            <label>Hearing Date & Time</label>
                            <input type="text" id="charge${id}Hearing" placeholder="MM/DD/YYYY, HH:MM AM/PM">
                        </div>
                    </div>
                    ${id > 1 ? '<button class="btn btn-danger" onclick="removeCharge(' + id + ')">Remove Charge</button>' : ''}
                </div>
            `;
            
            document.getElementById('chargesContainer').insertAdjacentHTML('beforeend', html);
            charges.push(id);
            updatePremiums();
        }

        function removeCharge(id) {
            document.getElementById(`charge-${id}`).remove();
            charges = charges.filter(c => c !== id);
            updatePremiums();
        }

        // ========== PREMIUM CALCULATION ==========
        function calculatePremium(bondAmount) {
            const amount = parseFloat(bondAmount) || 0;
            return amount < 1000 ? 100 : amount * 0.10;
        }

        function updatePremiums() {
            let totalBond = 0;
            let totalPremium = 0;
            let breakdown = '';
            
            charges.forEach((id, index) => {
                const bondInput = document.getElementById(`charge${id}BondAmount`);
                const premiumInput = document.getElementById(`charge${id}Premium`);
                const descInput = document.getElementById(`charge${id}Description`);
                
                if (bondInput && bondInput.value) {
                    const bondValue = parseFloat(bondInput.value) || 0;
                    const premium = calculatePremium(bondValue);
                    
                    if (premiumInput) {
                        premiumInput.value = premium.toFixed(2);
                    }
                    
                    totalBond += bondValue;
                    totalPremium += premium;
                    
                    const chargeText = descInput ? (descInput.value.substring(0, 40) || `Charge #${index + 1}`) : `Charge #${index + 1}`;
                    breakdown += `
                        <div style="margin:5px 0;padding:8px;background:#0b0e12;border:1px solid #1d232b;border-radius:8px">
                            ${chargeText}: $${bondValue.toFixed(2)} ‚Üí <strong>$${premium.toFixed(2)}</strong>
                        </div>
                    `;
                }
            });
            
            document.getElementById('premiumBreakdown').innerHTML = breakdown || '<div>Add charges to see premium breakdown</div>';
            document.getElementById('totalBond').textContent = '$' + totalBond.toFixed(2);
            document.getElementById('totalPremium').textContent = '$' + totalPremium.toFixed(2);
        }

        // ========== REVIEW TAB ==========
        function updateReviewTab() {
            const name = document.getElementById('defendantFullName').value || '-';
            document.getElementById('reviewDefendantName').textContent = name;
            document.getElementById('reviewChargeCount').textContent = charges.length;
            document.getElementById('reviewTotalBond').textContent = document.getElementById('totalBond').textContent;
            document.getElementById('reviewTotalPremium').textContent = document.getElementById('totalPremium').textContent;
        }

        // ========== LOAD ARREST DATA ==========
        function loadArrestData(bookingNumber, rowIndex) {
            console.log('üì° loadArrestData called with:', bookingNumber, rowIndex);
            
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('‚úÖ Server returned data:', data);
                    populateFormFromArrest(data);
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Server call failed:', error);
                    alert('Error loading arrest data: ' + error.message);
                    addCharge(); // Add empty charge as fallback
                })
                .getArrestDataForForm(bookingNumber, rowIndex);
        }

        // ========== POPULATE FORM (FIXED VERSION WITH DEBUGGING) ==========
        function populateFormFromArrest(data) {
            console.log('üì• populateFormFromArrest called');
            console.log('üì¶ Data object:', data);
            console.log('üìã Data keys:', Object.keys(data));
            
            if (!data) {
                console.error('‚ùå No data provided to populateFormFromArrest');
                addCharge();
                return;
            }

            // Field mapping with flexible key matching
            const fieldMappings = {
                'defendantFullName': data.Full_Name || data['Full Name'] || data.full_name || '',
                'defendantDOB': data.DOB || data.dob || data.Date_of_Birth || '',
                'defendantStreetAddress': data.Address || data.address || data.Street_Address || '',
                'defendantCity': data.City || data.city || '',
                'defendantDLState': data.State || data.state || 'FL',
                'defendantZip': data.ZIP || data.Zip || data.zip || data.Zip_Code || '',
                'defendantRace': data.Race || data.race || '',
                'defendantSex': data.Sex || data.sex || data.Gender || '',
                'defendantHeight': data.Height || data.height || '',
                'defendantWeight': data.Weight || data.weight || '',
                'defendantSSN': data.Person_ID || data['Person ID'] || data.person_id || ''
            };

            console.log('üó∫Ô∏è Field mappings created:', fieldMappings);

            // Populate defendant fields
            let populatedCount = 0;
            let notFoundCount = 0;

            Object.entries(fieldMappings).forEach(function([fieldId, value]) {
                const element = document.getElementById(fieldId);
                
                if (element) {
                    if (value && String(value).trim() !== '' && String(value) !== 'undefined') {
                        element.value = String(value);
                        element.classList.add('auto-filled');
                        populatedCount++;
                        console.log('‚úÖ Set ' + fieldId + ' = ' + value);
                    } else {
                        console.log('‚è≠Ô∏è Skipped ' + fieldId + ' (no data)');
                    }
                } else {
                    notFoundCount++;
                    console.warn('‚ö†Ô∏è Element not found: ' + fieldId);
                }
            });

            console.log('üìä Populated ' + populatedCount + ' fields, ' + notFoundCount + ' elements not found');

            // Handle charges with flexible key names
            const chargesData = data.All_Charges || data.Charges || data.charges || data['All Charges'] || '';
            console.log('‚öñÔ∏è Charges data:', chargesData);
            
            const chargesArray = String(chargesData)
                .split('|')
                .map(c => c.trim())
                .filter(c => c !== '' && c !== 'undefined');
            
            console.log('‚öñÔ∏è Parsed charges array:', chargesArray);

            if (chargesArray.length > 0) {
                const totalBondAmount = parseFloat(data.Bond_Amount || data.bond_amount || 0);
                const perChargeBond = chargesArray.length ? totalBondAmount / chargesArray.length : 0;
                
                // Parse case numbers with flexible key names
                const caseNumbersData = data.Case_Numbers || data['Case Numbers'] || data.case_numbers || data.Case_Number || '';
                const caseNumbers = String(caseNumbersData)
                    .split(',')
                    .map(s => s.trim());
                
                const courtLocation = data.Court_Location || data.court_location || '';
                const courtDate = data.Court_Date || data.court_date || '';
                const courtTime = data.Court_Time || data.court_time || '';
                const hearing = courtDate && courtTime ? (courtDate + ', ' + courtTime) : '';

                console.log('üìù Creating ' + chargesArray.length + ' charge items');

                chargesArray.forEach(function(charge, index) {
                    addCharge();
                    const chargeId = charges[charges.length - 1];
                    
                    const chargeFields = {
                        [`charge${chargeId}Description`]: charge,
                        [`charge${chargeId}BondAmount`]: perChargeBond.toFixed(2),
                        [`charge${chargeId}CaseNumber`]: caseNumbers[index] || caseNumbers[0] || '',
                        [`charge${chargeId}CourtLocation`]: courtLocation,
                        [`charge${chargeId}Hearing`]: hearing
                    };

                    Object.entries(chargeFields).forEach(function([fieldId, value]) {
                        const element = document.getElementById(fieldId);
                        if (element && value) {
                            element.value = value;
                            element.classList.add('auto-filled');
                            console.log('‚úÖ Set charge field ' + fieldId + ' = ' + value);
                        }
                    });
                });

                updatePremiums();
                console.log('‚úÖ Charges populated and premiums calculated');
            } else {
                console.log('‚ö†Ô∏è No charges found in data, adding empty charge');
                addCharge();
            }

            console.log('‚úÖ Form population complete');

            // Optional: Mark form as opened in the sheet
            if (typeof google !== 'undefined' && google.script && google.script.run && google.script.run.markFormOpened) {
                google.script.run.markFormOpened(data.Booking_Number || data.booking_number);
            }
        }

        // ========== FORM SUBMISSION ==========
        function submitForm() {
            const defendantName = document.getElementById('defendantFullName').value;
            const indemnitorName = document.getElementById('indemnitorFullName').value;
            
            if (!defendantName || !indemnitorName || charges.length === 0) {
                alert('Please fill in all required fields before submitting.');
                return;
            }
            
            alert('Form submission will be implemented with SignNow integration.\n\nFor now, this is a preview of the complete form.');
        }
    </script>
</body>

</html>
