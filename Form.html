<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }

    .form-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .form-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #1a73e8;
    }

    .form-header h1 {
      color: #1a73e8;
      margin: 0 0 10px 0;
      font-size: 28px;
    }

    .form-header p {
      color: #666;
      margin: 0;
    }

    .form-section {
      margin: 25px 0;
    }

    .form-section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }

    .form-group {
      flex: 1;
      min-width: 0;
    }

    .form-group.full-width {
      flex: 100%;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .btn-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background: #1557b0;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e8eaed;
    }

    .required {
      color: #d93025;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }

    .error {
      background: #fef7f7;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }

      .form-container {
        box-shadow: none;
        padding: 20px;
      }

      .btn-container {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="form-container">
    <div class="form-header">
      <h1>Bond Application Form</h1>
      <p>Complete all required fields</p>
    </div>

    <div id="loading" class="loading">
      Loading form data
    </div>

    <form id="bondForm" style="display: none;">
      <!-- Defendant Information -->
      <div class="form-section">
        <h2>Defendant Information</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Full Name <span class="required">*</span></label>
            <input type="text" id="defendantName" required>
          </div>
          <div class="form-group">
            <label>Date of Birth <span class="required">*</span></label>
            <input type="date" id="dob" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email">
          </div>
        </div>

        <div class="form-group full-width">
          <label>Address <span class="required">*</span></label>
          <input type="text" id="address" required>
        </div>
      </div>

      <!-- Arrest Information -->
      <div class="form-section">
        <h2>Arrest Information</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Arrest Date <span class="required">*</span></label>
            <input type="date" id="arrestDate" required>
          </div>
          <div class="form-group">
            <label>Booking Number <span class="required">*</span></label>
            <input type="text" id="bookingNumber" required>
          </div>
        </div>

        <div class="form-group full-width">
          <label>Charges <span class="required">*</span></label>
          <textarea id="charges" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Bond Amount <span class="required">*</span></label>
            <input type="text" id="bondAmount" required>
          </div>
          <div class="form-group">
            <label>Court Date</label>
            <input type="date" id="courtDate">
          </div>
        </div>
      </div>

      <!-- Indemnitor Information -->
      <div class="form-section">
        <h2>Indemnitor Information</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Indemnitor Name</label>
            <input type="text" id="indemnitorName">
          </div>
          <div class="form-group">
            <label>Relationship</label>
            <input type="text" id="relationship">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Indemnitor Phone</label>
            <input type="tel" id="indemnitorPhone">
          </div>
          <div class="form-group">
            <label>Indemnitor Email</label>
            <input type="email" id="indemnitorEmail">
          </div>
        </div>
      </div>

      <!-- Additional Notes -->
      <div class="form-section">
        <h2>Additional Information</h2>
        <div class="form-group full-width">
          <label>Notes</label>
          <textarea id="notes" placeholder="Any additional information..."></textarea>
        </div>
      </div>

      <div class="btn-container">
        <button type="button" class="btn btn-secondary" onclick="window.print()">
          Print Form
        </button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Save Application
        </button>
      </div>
    </form>
  </div>

  <script>
    console.log('Form script loaded');

    // Helper function to find value in array data structure
    function findValue(data, searchTerms) {
      if (!data || !Array.isArray(data)) {
        console.log('Data is not an array:', typeof data);
        return '';
      }

      // Search terms can be string or array
      const terms = Array.isArray(searchTerms) ? searchTerms : [searchTerms];

      for (let term of terms) {
        const lowerTerm = term.toLowerCase();
        for (let item of data) {
          if (Array.isArray(item) && item.length >= 2) {
            const key = String(item[0]).toLowerCase();
            // Check if key contains the search term
            if (key.includes(lowerTerm)) {
              console.log(`Found match: "${term}" -> "${item[0]}" = "${item[1]}"`);
              return item[1] || '';
            }
          }
        }
      }
      console.log(`No match found for: ${terms.join(', ')}`);
      return '';
    }

    // Format date from various formats to YYYY-MM-DD
    function formatDate(dateValue) {
      if (!dateValue) return '';

      try {
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) return '';

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
      } catch (e) {
        console.error('Date format error:', e);
        return '';
      }
    }

    // Populate form with data
    function populateForm(formData) {
      console.log('=== POPULATING FORM ===');
      console.log('Data received:', formData);
      console.log('Data type:', Array.isArray(formData) ? 'Array' : typeof formData);
      console.log('Data length:', Array.isArray(formData) ? formData.length : 'N/A');

      // Defendant Information
      document.getElementById('defendantName').value =
        findValue(formData, ['defendant name', 'defendant', 'name', 'full name']);

      document.getElementById('dob').value =
        formatDate(findValue(formData, ['dob', 'date of birth', 'birth date', 'birthdate']));

      document.getElementById('phone').value =
        findValue(formData, ['phone', 'telephone', 'cell', 'mobile', 'phone number']);

      document.getElementById('email').value =
        findValue(formData, ['email', 'e-mail', 'mail']);

      document.getElementById('address').value =
        findValue(formData, ['address', 'street', 'location', 'residence']);

      // Arrest Information
      document.getElementById('arrestDate').value =
        formatDate(findValue(formData, ['arrest date', 'date of arrest', 'arrested', 'arrest']));

      document.getElementById('bookingNumber').value =
        findValue(formData, ['booking number', 'booking #', 'booking', 'book number', 'book #']);

      document.getElementById('charges').value =
        findValue(formData, ['charges', 'charge', 'offense', 'crime', 'violation']);

      document.getElementById('bondAmount').value =
        findValue(formData, ['bond amount', 'bond', 'bail', 'bail amount']);

      document.getElementById('courtDate').value =
        formatDate(findValue(formData, ['court date', 'hearing date', 'court', 'hearing']));

      // Indemnitor Information
      document.getElementById('indemnitorName').value =
        findValue(formData, ['indemnitor name', 'indemnitor', 'cosigner', 'co-signer']);

      document.getElementById('relationship').value =
        findValue(formData, ['relationship', 'relation']);

      document.getElementById('indemnitorPhone').value =
        findValue(formData, ['indemnitor phone', 'cosigner phone', 'indemnitor telephone']);

      document.getElementById('indemnitorEmail').value =
        findValue(formData, ['indemnitor email', 'cosigner email', 'indemnitor e-mail']);

      document.getElementById('notes').value =
        findValue(formData, ['notes', 'comments', 'additional info', 'remarks']);

      // Show form, hide loading
      document.getElementById('loading').style.display = 'none';
      document.getElementById('bondForm').style.display = 'block';

      console.log('=== FORM POPULATED ===');
    }

    // Handle form submission
    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded');

      const form = document.getElementById('bondForm');
      const submitBtn = document.getElementById('submitBtn');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        console.log('Form submitted');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        const formData = {
          defendantName: document.getElementById('defendantName').value,
          dob: document.getElementById('dob').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          address: document.getElementById('address').value,
          arrestDate: document.getElementById('arrestDate').value,
          bookingNumber: document.getElementById('bookingNumber').value,
          charges: document.getElementById('charges').value,
          bondAmount: document.getElementById('bondAmount').value,
          courtDate: document.getElementById('courtDate').value,
          indemnitorName: document.getElementById('indemnitorName').value,
          relationship: document.getElementById('relationship').value,
          indemnitorPhone: document.getElementById('indemnitorPhone').value,
          indemnitorEmail: document.getElementById('indemnitorEmail').value,
          notes: document.getElementById('notes').value
        };

        console.log('Saving form data:', formData);

        google.script.run
          .withSuccessHandler(function () {
            console.log('Save successful');
            alert('Bond application saved successfully!');
            google.script.host.close();
          })
          .withFailureHandler(function (error) {
            console.error('Save failed:', error);
            alert('Error saving form: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Application';
          })
          .saveBondApplication(formData);
      });
    });

    // Load data when page loads
    window.addEventListener('load', function () {
      console.log('Window loaded, fetching data...');

      google.script.run
        .withSuccessHandler(function (data) {
          console.log('Data fetch successful');
          populateForm(data);
        })
        .withFailureHandler(function (error) {
          console.error('Data fetch failed:', error);
          document.getElementById('loading').innerHTML =
            '<div class="error">Error loading form data: ' + error.message + '</div>';
        })
        .getArrestData();
    });
  </script>
</body>

</html>